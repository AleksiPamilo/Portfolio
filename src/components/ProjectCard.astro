---
import type { CollectionEntry } from 'astro:content';

interface Props {
  project: CollectionEntry<'projects'>;
  index?: number;
}

const { project, index = 0 } = Astro.props;
const { title, description, image, techStack, repoUrl, url } = project.data;
const formattedDescription = description.replace(/\s*Solution:/i, '\nSolution:');
---

<article class="project-card reveal rounded-lg border p-6 md:p-7 transition duration-200 hover:-translate-y-0.75" style={`--reveal-delay:${Math.min(index * 100, 380)}ms`}>
  <div class:list={[
    "grid items-center gap-6 md:gap-7",
    image ? "grid-cols-1 lg:grid-cols-5" : "grid-cols-1"
  ]}>
    
    {image && (
      <div class="lg:col-span-2">
        <button 
          class="zoom-trigger w-full cursor-zoom-in focus:outline-none text-left"
          aria-label={`Enlarge ${title} image`}
        >
          <div class="project-card__image-shell relative aspect-video overflow-hidden rounded-lg border">
            <img 
              src={image} 
              alt={title}
              class="project-card__image h-full w-full object-cover opacity-90 transition-all duration-500"
              loading="lazy"
            />
            <div class="project-card__image-ring pointer-events-none absolute inset-0 rounded-lg"></div>
          </div>
        </button>
      </div>
    )}

      <div class:list={[
      "flex flex-col justify-center",
      image ? "lg:col-span-3" : "" 
    ]}>
      <div class="mb-4 flex items-start justify-between gap-4">
        <h3 class="m-0 text-[0.98rem] font-semibold transition-colors duration-200">
          {title}
        </h3>

        {(repoUrl || url) && (
          <div class="inline-flex items-center gap-2">
            {url && (
              <a href={url} target="_blank" rel="noopener noreferrer" class="project-card__repo" aria-label={`Open ${title} website`}>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              </a>
            )}
            {repoUrl && (
              <a href={repoUrl} target="_blank" rel="noopener noreferrer" class="project-card__repo" aria-label={`Open ${title} repository`}>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
              </a>
            )}
          </div>
        )}
      </div>

      <p class="project-card__description m-0 text-[0.88rem] leading-[1.72]">
        {formattedDescription}
      </p>

      <div class="project-card__stack mt-5 flex flex-wrap justify-start gap-2.5 sm:justify-end">
        {techStack.map(tech => (
          <span class="project-tech rounded-sm border px-2 py-1 text-[0.66rem]">
            {tech}
          </span>
        ))}
      </div>
    </div>
  </div>

  {image && (
    <dialog class="zoom-modal cursor-zoom-out">
      <div class="flex items-center justify-center w-screen h-screen p-4 md:p-12">
        <img 
          src={image} 
          alt={title}
          class="max-w-full max-h-full object-contain rounded-md shadow-2xl"
        />
      </div>
    </dialog>
  )}
</article>

<script>
  const cards = document.querySelectorAll('article');

  cards.forEach(card => {
    const trigger = card.querySelector('.zoom-trigger');
    const modal = card.querySelector('.zoom-modal') as HTMLDialogElement;

    if (trigger && modal) {
      trigger.addEventListener('click', () => modal.showModal());
      modal.addEventListener('click', () => modal.close());
    }
  });
</script>

<style>
  .zoom-modal {
    padding: 0;
    background: transparent;
    border: none;
    max-width: none;
    max-height: none;
  }

  .zoom-modal::backdrop {
    background: color-mix(in oklab, var(--bg), black 30%);
    backdrop-filter: blur(7px);
  }

  .zoom-modal[open] {
    animation: fadeIn 0.22s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>