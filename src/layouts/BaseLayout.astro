---
import '../styles/global.css';

interface Props {
    title?: string;
    description?: string;
    image?: string;
    noindex?: boolean;
}

const {
    title = 'Aleksi Pamilo Portfolio',
    description = 'Portfolio of Aleksi Pamilo, a software engineer in Finland focused on .NET, Vue, TypeScript.',
    image = '/logo.png',
    noindex = false,
} = Astro.props;

const siteOrigin = Astro.site ? new URL(Astro.site) : new URL(Astro.url.origin);
const canonicalUrl = new URL(Astro.url.pathname, siteOrigin).toString();
const ogImageUrl = image.startsWith('http') ? image : new URL(image, siteOrigin).toString();
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <meta name="description" content={description} />
        <meta name="author" content="Aleksi Pamilo" />
        <link rel="canonical" href={canonicalUrl} />
        <meta property="og:type" content="website" />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:site_name" content="Aleksi Pamilo Portfolio" />
        <meta property="og:image" content={ogImageUrl} />
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={title} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={ogImageUrl} />
        {noindex && <meta name="robots" content="noindex, nofollow" />}
        <title>{title}</title>
        <slot name="head" />
        <script is:inline>
            (() => {
                const key = 'portfolio-theme';
                const savedTheme = localStorage.getItem(key);
                const preferred = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
                document.documentElement.dataset.theme = savedTheme ?? preferred;
            })();
        </script>
    </head>
    <body class="site-body">
        <button class="theme-toggle" id="theme-toggle" type="button" aria-label="Toggle theme">
            <span class="theme-toggle__icon" id="theme-icon">◐</span>
            <span class="theme-toggle__text" id="theme-label">Theme</span>
        </button>
        <slot />

        <script is:inline>
            (() => {
                const root = document.documentElement;
                const themeButton = document.getElementById('theme-toggle');
                const icon = document.getElementById('theme-icon');
                const label = document.getElementById('theme-label');
                const key = 'portfolio-theme';

                const setTheme = (theme) => {
                    root.dataset.theme = theme;
                    localStorage.setItem(key, theme);
                    if (icon) icon.textContent = theme === 'light' ? '☀︎' : '☾';
                    if (label) label.textContent = theme === 'light' ? 'Light' : 'Dark';
                };

                themeButton?.addEventListener('click', () => {
                    const nextTheme = root.dataset.theme === 'light' ? 'dark' : 'light';
                    setTheme(nextTheme);
                });

                setTheme(root.dataset.theme === 'light' ? 'light' : 'dark');

                const revealElements = Array.from(document.querySelectorAll('.reveal'));
                if (revealElements.length > 0) {
                    const observer = new IntersectionObserver(
                        (entries, instance) => {
                            entries.forEach((entry) => {
                                if (entry.isIntersecting) {
                                    entry.target.classList.add('is-visible');
                                    instance.unobserve(entry.target);
                                }
                            });
                        },
                        { threshold: 0.14, rootMargin: '0px 0px -6% 0px' }
                    );

                    revealElements.forEach((element, index) => {
                        element.style.setProperty('--reveal-delay', `${Math.min(index * 50, 280)}ms`);
                        observer.observe(element);
                    });
                }
            })();
        </script>
    </body>
</html>